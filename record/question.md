# 记录

## Java基础

* 线程池参数设定，为什么这么设定，作用？7大参数

  线程池原理

* 优先级队列的底层原理

  最大堆、最小堆

* java hashMap和redis map的rehash有什么区别？

   Java hashMap rehash基于高低位链表,当前节点数组下标元素rehash不变或+旧的容量,存在线程安全问题和fail-fast 
   
   redis字典中包含两个哈希表和trehashidx，当标识为-1代表未进行rehash,rehash过程是ht[0]表数据迁移到ht[1],整个hash的过程是渐进式rehash分多次执行完成防止因为某个槽key太多停止服务,在rehash的过程中删除,查找,更新等操作会在两个哈希表执行

* java的线程池你们是怎么用的？原理是什么？怎么设置参数？有哪些状态？用了线程池有哪些问题？你们怎么解决的？Future是干嘛的？

  线程池工作原理，老师架构课画图讲过，下面这张图，边画边跟面试官讲

  ![](./img/线程池.jpg)
  
  线程池状态:初始状态-->可运行状态-->运行状态-->休眠状态-->终止状态 ; 
  线程池问题:无界队列OOM(使用有界队列和备忘录),过饱问题:增加消费者或自定义拒绝策略降低消费者速率 ; 
  future:对runnable或callable的执行结果处理

* 简述HashMap的底层原理 

  1. hash算法：为什么要⾼位和低位做异或运算？答：让⾼位也参与hash寻址运算，降低hash冲突 
  2. hash寻址：为什么是hash值和数组.length - 1进⾏与运算？答：因为取余算法效率很低，按位与运算效率⾼
  3. hash冲突的机制：链表，超过8个以后，红⿊树（数组的容量⼤于等于64） 
  4. 扩容机制：数组2倍扩容，重新寻址（rehash），hash & n - 1，判断⼆进制结果中是否多出⼀个 bit的1，如果没多，那么就是原来的index，如果多了出来，那么就是index + oldCap，通过这个⽅式。就 避免了rehash的时候，⽤每个hash对新数组.length取模，取模性能不⾼，位运算的性能⽐较⾼ JDK 1.8以后，优化了⼀下，如果⼀个链表的⻓度超过了8，就会⾃动将链表转换为红⿊树，查找的性能， 是O(logn)，这个性能是⽐O(n)要⾼的
  5. 红⿊树是⼆叉查找树，左⼩右⼤，根据这个规则可以快速查找某个值 
  6. 但是普通的⼆叉查找树，是有可能出现瘸⼦的情况，只有⼀条腿，不平衡了，导致查询性能变成 O(n)，线性查询了
  7. 红⿊树，红⾊和⿊⾊两种节点，有⼀⼤堆的条件限制，尽可能保证树是平衡的，不会出现瘸腿的情况 
  8. 如果插⼊节点的时候破坏了红⿊树的规则和平衡，会⾃动重新平衡，变⾊（红 <-> ⿊），旋转，左 旋转，右旋转



* volatile关键字底层原理，volatile关键字是否可以禁⽌指令重排以及如何底层如何实现的指令重排 

   1. 这⾥贴下⽯杉⽼师在讲volatile关键字底层原理画的图：硬件级别的原理: http://note.youdao.com/s/Mr2SnBoK 下⾯是我根据⽼师的思路学习的笔记
   2. 主动从内存模型开始讲起，原⼦性、可⻅性、有序性的理解，volatile关键字的原理 java内存模型：http://note.youdao.com/s/MKm6vAP8
   3. 可⻅性：⼀个线程修改了变量，其他线程能⻢上读取到该变量的最新值    read（从主存读取），load（将主存读取到的值写⼊⼯作内存），use（从⼯作内存读取数据来计 算），assign（将计算好的值重新赋值到⼯作内存中），    store（将⼯作内存数据写⼊主存），write（将store过去的变量值赋值给主存中的变量）     这个是流程图：http://note.youdao.com/s/XazdAWWu
   4. volatile读的内存语义如下：当读⼀个volatile变量时，JMM会把该线程对应的本地内存置为⽆效。 线程接下来将从主内存中读取共享变量。    
   这个是流程图：http://note.youdao.com/s/GBzGnrOH  
      * 当读flag变量后，本地内存B包含的值已经被置为⽆效。此时，线程B必须从主内存中读取共享变 量，线程B的读取操作将导致本地内存B与主内存 中的共享变量的值变成⼀致。  
      * volatile写和volatile读的内存语义总结： 线程A写⼀个volatile变量，实质上是线程A向接下来将要读这个volatile变量的某个线程发出了（其对共享 变量所做修改的）消息。 线程B读⼀个volatile变量，实质上是线程B接收了之前某个线程发出的（在写这个volatile变量之前对共享 变量所做修改的）消息。 线程A写⼀个volatile变量，随后线程B读这个volatile变量，这个过程实质上是线程A通过主内存向线程B发送消息。
    5. 锁的释放和获取的内存语义：当线程释放锁时，JMM会把该线程对应的本地内存中的共享变量刷新到主内存中。当线程获取锁时，JMM会把该线程对应的本地内存置为⽆效。从⽽使得被监视器保护的临界区代码必须从主内存中读取变量。
    6. 有序性：基于happens-before原则来看volatile关键字如何保证有序性    
    这个是流程图：http://note.youdao.com/s/BPU2J7te   
    happens-before规则 
    * 程序顺序规则：⼀个线程中的每个操作，happens-before于该线程中的任意后续操作。 
    * 监视器锁规则：对⼀个锁的解锁，happens-before于随后对这个锁的加锁
    * volatile变量规则：对⼀个volatile变量域的写，happens-before于任意后续对这个volatile域的读
    * 传递性：如果A happens-before B，且B happens-before C，那么A happens-before C。 
    * start()规则：如果线程A执⾏操作ThreadB.start()（启动线程B），那么A线程的 ThreadB.start()操作happens-before于线程B中的任意操作。 
    * join()规则：如果线程A执⾏操作ThreadB.join()并成功返回，那么线程B中的任意操作happensbefore与线程A从ThreadB.join()操作成功返回。

    7. 原⼦性：volatile关键字不能保证原⼦性，唯⼀的场景就是在32位虚拟机，对long/double变量的赋 值写是原⼦的，volatile关键字底层原理，lock指令以及内存屏， 
    8. lock指令：volatile实现的两条原则 
    * Lock前缀指令会引起处理器缓存回写到内存。 
    * ⼀个处理器的缓存回写到内存会导致其他处理器的缓存失效。 
    * 缓存⼀致性协议：http://note.youdao.com/s/NDbe0gMB


* 说下对ThreadLocal认知，项目中的应用场景

    我:xxx场景，常用方法，原理，可能出现的内存泄漏问题，一般如何解决

* 讲讲你知道的一些锁

    我:公平锁和非公平锁,可重入锁(可递归)和非可重入锁,独享锁和共享锁,互斥锁 / 读写锁,乐观锁 / 悲观锁,自旋锁......

    然后根据锁提出的，讲讲synchronized和ReentractLock的原理和区别
    我:从硬件层面讲到java层面，举出了区别和应用场景，说道了哪些框架和源码用了

* 线程的一些方法wait,notify，condition await() signal()

   我:先从方法属于什么类，有什么作用，一般什么场景用，有什么区别，甚至可以说下替代方案(表明自己的一个技术广度)



* 说下HashMap吧，1.7和1.8有什么区别，了解红黑树吗?1.8为什么这么用红黑树
  
   我:xxx ,最关键是死循环，底层数据结构的变化，说了一些红黑树特性，具体没特别深入研究

*  讲讲为什么ConcurrentHashMap是并发安全的吧，既然有锁怎么去统计size呢

   我:xxx，从1.7讲到1.8,从分段锁讲到cas+sync....size的统计1.7和1.8也有区别

*  sync的底层实现，锁优化，和lock的对比等

    todo

* Java 的锁怎么实现的？有哪些？HashMap key可以为null,为什么ConcurrentHashMap key 不可以为null ?非公平锁怎么实现的？AQS每个Node里的节点状态是干嘛用的？

  锁的实现基于aqs,常用ReentrantLock ReentrantReadWriteLock ; ConcurrentHashMap不能为null原因,无法去判断到底是key不存在还是value为null; 非公平锁基于cas实现 ;节点状态 CANCELLED:已取消调度 SIGNAL:唤醒后继节点 CONDITION:等待其他线程调用condition.signal()从等待队列到同步队列中获取锁 PROPAGATE:共享模式 前继节点不仅会唤醒后续节点

* Synchronized  volatile 的作用？原理？怎么用？什么时候用


    synchronized原理图

    ![](./img/sync.jpg)

    volatile原理图

    ![](./img/volatile.jpg)
    
   volatile常用场景优雅停机 注册中心服务实例心跳可见等,建议大家看下老师面试突击第三季并发部分内容，对上面这些关键字均有硬件级别的讲解

### 资料
  * 集合
  
   来源于老师的架构班，跟老师一起看的源码，总结的
  链接：http://note.youdao.com/noteshare?id=efd2a3a29d2626acea2b053e56bae5cc

  * 线程池

  来源于老师的架构课，以下是我自己的总结：
http://note.youdao.com/noteshare?id=e58584311f5cb3b89154fcac6c1d8004&sub=8037451384FE4687AC50C9A16C7C33EB

* 并发

  来源于老师的架构课，下面是自己的总结：
https://blog.csdn.net/qq_17164811/article/details/107432496


## Redis

* redis分布式的认知，让你自己线程一个redis分布式锁你怎么实现

   我:应用场景，不用分布式锁会有什么问题，分布式锁如何解决这个问题，还存在什么问题，如何去解决，原理清楚吗？是否还有其他的替代方案，让你自己设计你怎么写

*  redis了解多少?需要设计一个大数据新闻推荐功能你怎么设计?设计一个附近的人功能你怎么设计
  
   我:从数据结构，架构说，新闻推荐可以往布隆过滤说，附近的人可以往基于geohash和有序集合

*  讲讲zset的数据机构，一般应用在什么场景，你项目中有用过吗?解释下跳表
    
    我:底层是跳表实现的，比如会应用在点赞排行榜之类的场景，xxxx
redis数据结构，使用场景，微博场景使用redis如何去设计用户关系

* redis你了解哪些？你工作什么场景用？底层数据结构有哪些？分布式锁怎么用？有哪些问题？你们怎么解决的？数据一致性你们怎么做的？分布式事务了解不？你们用过没？你们怎么用的？用了之后有啥问题？你们怎么解决的？redis如何可以动态扩容和缩容？如果你来设计，你怎么设计？

   redis 数据结构类型 内存淘汰策略 过期策略 持久化rdb和aof  主从集群(哨兵高可用) 复制和redisCluster这些建议大家看一下《redis设计与实现》 ; 分布式锁:原生set nx ex+lua(get+del)或redisson hash结构支持可重入 或redLock或优化版本加上栅栏验证token ;数据库和缓存一致性推荐大家看一下老师早期出的亿级流量;分布式事务这里就直接引用老师gitee上的文章了
https://gitee.com/shishan100/Java-Interview-Advanced/blob/master/docs/distributed-system/distributed-transaction.md

   ![](./img/redis.jpg)


### 资料

* Redis

  1、Redis底层原理从架构班学的，这个我没总结过，就直接看的老师的笔记
  2、redis和 mysql 双写一致性问题，这个看的老师的面试突击的笔记
https://gitee.com/shishan100/Java-Interview-Advanced/blob/master/docs/high-concurrency/redis-consistence.md

  分布式锁
来源于老师的架构课，简单分享两个图
http://note.youdao.com/s/S0EK0NSx


## 数据库

* 讲讲mysql索引，原理是什么，如何优化索引

  我: xxxx,B+树，为什么要用B+树,有什么优点

*  给你个sql,你说一下怎么创建索引？索引结构？联合索引为什么用要存储主键id，存主键id的内存地址不行吗？索引计划有哪些指标，你关注哪些指标？你了解mysql哪些锁？都是干嘛的？什么操作会有锁？需要注意什么？

   根据具体的sql来创建索引,联合索引最左原则(字段不超过5个),索引个数5个以内 ; 索引结构:b+树叶子节点存储数据页 ; 如果存储地址值需要二次寻址 ;执行计划指标:select_type type 可能使用的索引 优化器实际使用索引等,主要关注连接类型type,索引使用情况和extra中内容 ; mysql锁:全局锁 表锁(显示锁和元数据锁MDL) 临界锁(间隙锁+行锁),锁注意事项主要还是死锁学会通过show engine innodb status来分析死锁案例  这里推荐大家看下儒猿技术窝的mysql专栏，里面有很详细的讲解


### 资料

* Mysql

  我是看的救火队长的MySQL专栏，我这里总结了一篇，抛砖引玉，后续的大家可以自己总结一下，自己整理一遍之后，你会发现这些知识脉络都会很清晰的：
http://note.youdao.com/noteshare?id=41b1f3021980dd84aa37bb110268954d&sub=18CF524AB8C64EB388EF47BE22EA3D64


## JVM

* 讲讲你对垃圾回收机制的理解(问题问的很宽泛，就看你怎么回答和理解)

  我:什么是垃圾，为什么要回收，不回收有什么问题，jvm有哪些区域，分别采用哪些回收方案，每个方案有哪些优缺点，为什么适合这个区域

* 面试官: 为什么年轻代e,s1,s2是8:1:1
  
  我:xxxx,内存利用率能方面讲

* 面试官: 工作中有解决过gc问题吗？什么场景下出现的，你如何去排查和解决

  jvm参数调优详细过程，到为什么这么设置，好处，一些gc场景，如何去分析gc日志

* jvm结构？你们jvm的参数是怎么设置的？gc情况怎么样？怎么调优？我们项目的机器差不多每3天一次fullgc,GC已经不能再调优了，这个问题你有啥好的想法吗？

  jvm结构:堆 虚拟机栈 本地虚拟机栈 程序计数器 元空间 ;参数设置新生代3G 1:1:8 老年代:1G ,gc情况大概几分钟到几十分钟一次minor gc 每次大概3-5ms左右,几小时一次full gc 每次不超过1s
  jvm调优:策略:
  1. 对象预留在新生代 
  2. 大对象直接进入老年代 
  3. 设置合理的对象年龄阀值; 3天full gc一次不能优化,当时没回答好说了一下升级为zgc,zgc推荐看一下美团技术团队分享文章 https://mp.weixin.qq.com/s/ag5u2EPObx7bZr7hkcrOTg
  ps：CMS和G1问的比较多，大家面试准备的时候多看看


### 资料

  
* 这个把救火队长的jvm吃透了，特别是调优的部分。这个很重要，能拿下的几个offer，这个专栏功不可没。把整个专栏学完后，自己默写一遍才能融汇贯通
下面这个是我默写的
https://blog.csdn.net/qq_17164811/article/details/107141112


## Spring

* 说说springBean的一个加载流程吧，如何解决循环依赖问题

   我:xxx,讲下什么是循环依赖，哪些情况会造成循环依赖，如何解决循环依赖(重点说明单例，缓存)

* spring事务了解吗，讲讲原理，@Transactional作用在方法A,B的事务生效情况
 
  我:xxx,从代理层面，从事务的传播特性讲

*  讲讲spring的AOP吧，业务中有用到吗？如何实现的，不同代理实现的区别
  
  我:xxx面向切面编程,jdk动态代理和cglib代理方向讲，区别最主要是属于不一样，修饰地方不一样。

* spring的循环依赖如何解决？为什么要三级缓存？

## 分布式

* 说说CAP理论吧，为什么只可能是CP或者AP呢？C和A为什么不能共存

  我:先解散概念，举例说明一致性和可靠性为什么不能共存，最好可以举例哪些框架是CP或者AP的

* 了解gissip协议吗？跟raft和paxos有什么区别，zk有了解吗？用的什么协议
 
  我:xxxx 主要从CP和AP入手，以及协议的应用框架,优缺点，为什么这么用


* 讲讲分布式事物吧，你熟悉的分布式事物框架，项目中有应用吗？框架的原理是什么？如果让你自己去设计你怎么设计
   
   我:ttc,最终消息一致性，最大努力通知，分别用在什么场景，底层怎么实现的去回答


### 资料

*  ByteTCC

  来源于老师的架构课，这个也是个杀手锏，这个我自己总结的不多，大体上看的都是老师的笔记，我就简单分享一下
http://note.youdao.com/noteshare?id=2bd16f1dc4641721f11c22d8b02085d7&sub=EA30000449C04FA9B6525FEFE5D7AF9E


## 消息队列

* 我看你们项目中有用消息中间件，你们用的哪些，怎么去选型呢
 
   我:主要是rocketmq和kafka,讲讲区别，讲讲不同的应用场景


*  讲讲kafka的实现原理，为什么能支撑这么高的吞吐量，如何保证高可用，讲讲高水位机制的原理和流程以及ISR机制

  我:主要从batch+oscache+磁盘顺序写讲，讲讲partition的多副本存储，如何去选举leader的等等---一般面试官都

*  kafka网络协议是怎么样的？为什么不用netty去写？你了解nio吗？讲讲跟bio的区别

  我:关注直接用nio写网络编程，netty第三方框架可能不稳定，主要从同步阻塞和同步非阻塞入手

* rocketmq的原理你有了解吗，跟kafka有什么异同点

  我:(先承认没看过源码，但是有特地去了解过，所以回答的时候不用这么深)主要从mq的broker,NameNode,消费者，生成者四个模块将，然后消息的发送和写入跟kafka有什么区别，集群模式有什么区别，应用场景有什么不同。


* MQ你们用的啥？什么业务场景使用？你是怎么考虑用MQ的？原理你知道多少？MQ有哪些问题需要注意？

  这个老师讲的面试题突击第一季的时候讲了mq的连环炮。大家可以看一下。


## RPC

*  你熟悉微服务，你们用什么微服务框架，讲讲springcloud dubbo选型 

  我:两者我在两家公司分别都用过，springcloud看过源码，dubbo也有研究过原理，xxx优缺点

*  讲讲springcloud的eureka原理，讲讲A服务是如何调用B服务的

   我:从服务注册和发现入手，讲讲eureka的核心原理，二级缓存，心跳机制等


### 资料

* SpringCould
  
  来源于老师的架构课，老师带着读了一整遍Spring Cloud几个核心组件的源码，这个没经老师允许我不能把太细节的分享出来，就把我自己学习之后的总结分享出来一些

  Spring Cloud可以说是我面试的杀手锏吧，只要问我这个，这轮面试就成功一半了，我拿eureka举例，下面这个是我学完Eureka源码之后自己的总结笔记：
http://note.youdao.com/noteshare?id=4c615d4a2635339c60d558fe17541f0d&sub=D11A87445C014EAE8F9C23F8D80B9D16

## 网络

* 面试官问，2020年6月18号，晚上18:00点，浏览器输入了jd.com，你把整个过程给我画个图，越详细越好
这个图取决你的薪资，这个是面试官原话

  我的理解：这个问题，大家一看可能就是一道网络题，dns啊，加上一些网络包的层层封装，之前面试突击老师也讲过，但是这里有个日期就是6月18号，这个时间有点特殊，可能就会要考虑我们后端的一些东西，比如架构的东西，你就可以说一下，这个首页你要做你怎么做的，是不是用缓存啊，网关怎么走的啊，用什么缓存啊，用不用CDN啊，大家尽可能去发挥自己的架构能力，我就是按照这个思路回答的


## 设计

* 讲讲你们如何利用爬虫去破解(抓取)一个网站的数据的吧，中间遇到的最困难的问题是什么
* 你遇到过哪些风控策略，你是怎么去解决的，图形验证码你怎么解决，对神经网络有了解吗?
* 反过来，你对你自己的网站，有哪些安全的风控需要注意，你一般会去如何设计
* 你如何设计一个通用化的爬虫，以应对我对不同网站，不同需求的变化。
* 设计一个分布式文件存储系统，你会如何去设计
* 设计一个微服务注册中心，你会如何去设计

* 要做一个项目，全世界的人聊天app，现在一期只实现发送文字聊天，朋友列表，朋友圈，你给我画一下整个架构图。机器如何部署？
  
  我的理解:聊天大概就是IM，获取朋友圈或者朋友列表，可以用http业务系统的架构来做，这里可能就是IM架构怎么设计，业务系统怎么设计，大概就是画一下这两个系统怎么设计，机器部署的话，因为是全世界，可能需要多机房部署，数据同步之类也要说说。我是按照这个思路回答的。

* 设计一个通用限流器,10、100、1000、10w、1000w的qps可以随意配置，误差率在99%

  我的理解：在qps小于一定阈值的时候，可以用全局计数器来作为全局限流，如果qps高于一个阈值，就分配到每个机器上，本地做限流，定期汇报，然后重新分配。我大概就是按照这个思路讲的，限流算法大家也可以学习一下，比如令牌桶、计数器、滑动串口等，也可以参考一下sentinel的设计和架构。
* 设计一个点赞、评论系统，你怎么考虑？
  
  我的理解：如果要求数据实时性比较高的话，可以通过一些flink实时计算来进行统计，如果实时性要求不高，可以本地缓存一下，定期更新，大概就是按照这个思路回答的。

* 现在有一个需求，本来不是你们组负责，但是由于一些其他原因，这个功能要由你们组来负责，你是怎么考虑的？

  其实这个问题我感觉不太好回答，当时我是这么回答的，作为一下参考，我说如果这个需求比较急的话，我们可以先做，如果以后有关于这个需求的更新迭代，可以慢慢移植到其他组，自己做业务闭环，好维护。

* MQ延迟队列你知道多少？你能设计一下吗？你能设计一个支持事务的MQ的功能吗？

  这个大家可以参考一下rocketmq的说一下延迟队列是怎么做的。事务的话可以参考一下kafka是怎么设计的。